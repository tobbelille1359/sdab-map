<!doctype html>
<html lang="sv">

<head>
	<link rel="icon" href="./sdab_small.png" />
<link rel="preload" as="image" href="./sdab_small.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SDAB – Levande karta</title>
  <style>
    /* English comments in CSS per your preference */
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }

    .loading {
      position: fixed; inset: 0; display: grid; place-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #fff; z-index: 10;
    }
    .badge{
  position:fixed;left:12px;bottom:12px;z-index:6;
  display:inline-flex;align-items:center;gap:8px;
  background:#D9E0D9;color:#0A4003;border:2px solid #0A4003;
  border-radius:999px;padding:6px 12px 6px 8px;
  box-shadow:0 6px 14px rgba(0,0,0,.22);
  font:14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
}
.badge-icon{
  width:26px;height:26px;flex:0 0 26px;
  border-radius:50%;background:#D9E0D9;border:1px solid #0A4003;
  display:grid;place-items:center;}
	
.badge-icon img{ width:16px;height:16px;border-radius:50%;display:block; }
.badge-text{ white-space:nowrap; }

    /* === Advanced marker "badge" with SDAB logo === */
    .sdab-pin {
      /* Size of the circular marker */
      width: 34px; height: 34px; border-radius: 50%;
      display: grid; place-items: center;
      background: #D9DFD9;                         /* inner bg */
      border: 1px solid var(--sdab-green, #2E7D32);/* green border */
      box-shadow: 0 2px 8px rgba(0,0,0,.28);       /* pop! */
      transform: translate3d(0,0,0);
    }
    .sdab-pin img {
      width: 18px; height: 18px; display: block; border-radius: 50%;
    }

    /* === Nicer InfoWindow content === */
    .infocard {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: 320px;
    }
    .infocard .title {
      font-size: 16px; font-weight: 700; margin: 0 0 4px 0;
    }
    .infocard .addr {
      color: #374151;
    }
	/* Brandad info card (outer frame + inner panel) */
/* English comments as requested */
.sdab-card {
  --sdab-bg: #D9E0D9;      /* light beige/green */
  --sdab-border: #0A4003;  /* dark green */
  --sdab-shadow: 0 10px 24px rgba(0,0,0,.18);

  background: var(--sdab-bg);
  border: 2px solid var(--sdab-border) !important;
  border-radius: 28px;
  box-shadow: var(--sdab-shadow);
  padding: 16px 18px 18px;
  max-width: min(480px, 86vw);
  font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: #0A4003;
}

/* header row with logo */
.sdab-card__header {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 12px;
}
.sdab-card__logo {
  height: 28px; width: auto; display: block;
}

/* inner white panel */
.sdab-card__panel {
  background: #ffffff;
  border-radius: 22px;
  padding: 14px 16px;
  border: 1px solid #E5E7EB; /* subtle */
}

/* title + address */
.sdab-card__title {
  font-size: 16px; font-weight: 500; margin: 0 0 6px 0; color: #0A4003;
}
.sdab-card__addr { margin: 0; color: #374151; }

/* Remove the default white bubble from Google InfoWindow */
.gm-style-iw, .gm-style-iw-c {
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}

/* Remove the tip arrow shadow */
.gm-style-iw-t::after, .gm-style-iw-t::before {
  background: transparent !important;
  box-shadow: none !important;
}

.sdab-card {
  border-radius: 16px;   /* was 28px */
  border: 5px solid #0A4003;
  padding: 14px 16px 16px;
}
.sdab-card__panel {
  border-radius: 12px;   /* was 22px */
}

.gm-ui-hover-effect { display: none !important; }

.sdab-close {
  margin-left: auto;
  background: transparent;
  border: none;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  color: #0A4003;
}
/* Ensure the content area allows clicks and isn't clipping */

.sdab-card, .sdab-close { pointer-events: auto; }

/* Se till att innehållet tar emot klick */
.gm-style-iw-d { overflow: visible !important; }
.gm-ui-hover-effect { display: none !important; } /* vi kör vår egen knapp */

/* Se till att ingen parent blockerar klick */
.gm-style-iw-d { overflow: visible !important; pointer-events: auto !important; }

	  /* City search UI */
.search {
  position: fixed; right: 12px; top: 60px; z-index: 6;
  display: flex; gap: 6px; align-items: center;
  background: rgba(255,255,255,.95);
  border: 1px solid #E5E7EB; border-radius: 10px;
  padding: 8px 10px; box-shadow: 0 4px 14px rgba(0,0,0,.06);
  font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}
.search input {
  width: 220px; border: 0; outline: none; background: transparent;
}
.search button {
  border: 0; background: #0A4003; color: #fff; padding: 6px 10px;
  border-radius: 8px; cursor: pointer;
}
.search button.secondary {
  background: #D9E0D9; color:#0A4003;
}

  </style>
</head>
<body>
  <div class="loading" id="loading">Laddar karta…</div>
	<div class="search">
  <input id="cityInput" type="search" placeholder="Sök ort eller postnummer" />
  <button id="cityGo">Sök</button>
  <button id="cityClear" class="secondary">Rensa</button>
</div>


  <div id="map"></div>
  <div class="badge" id="badge">
  <span class="badge-icon"><img src="./sdab_small.png" alt=""></span>
  <span class="badge-text">0 hämtställen</span>
</div>
  <!-- MarkerClusterer (works with Advanced Markers) -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<script>
"use strict";

/* === CONFIG === */
const API_URL       = "https://sdabgetpickupplaces.azurewebsites.net/api/pickup-places?";
const SDAB_LOGO_URL = "./sdab_small.png";
const DEFAULT_CENTER= { lat: 62.0, lng: 15.0 };
const DEFAULT_ZOOM  = 5;
const MAP_ID        = "DEMO_MAP_ID";
const GMAPS_SRC     = "https://maps.googleapis.com/maps/api/js?v=weekly&libraries=marker&loading=async&key=$GMAPS_KEY&callback=initMap";

/* === LOAD MAPS === */
function loadMaps(){
  const s=document.createElement("script");
  s.src=GMAPS_SRC; s.async=true; document.head.appendChild(s);
}

/* === HELPERS === */
async function fetchPickupPlaces(){
  const r = await fetch(API_URL);
  if(!r.ok) throw new Error("API error "+r.status);
  return r.json();
}
function parseLocationString(loc){
  if(!loc) return null;
  const [lat,lng]=String(loc).split(",").map(Number);
  return (Number.isNaN(lat)||Number.isNaN(lng))?null:{lat,lng};
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}
function norm(s){
  return String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/å/gi,"a").replace(/ä/gi,"a").replace(/ö/gi,"o")
    .toLowerCase().trim();
}

/* === SIMPLE BADGE === */
function makeSetBadge(){
  const badge = document.getElementById("badge");
  const badgeText = badge?.querySelector(".badge-text");
  return function setBadge(count, queryRaw){
    const n = Number.isFinite(+count) ? +count : 0;
    const q = String(queryRaw ?? "").trim();
    const plural = n === 1 ? "hämtställe" : "hämtställen";
    const text = q ? `${n} ${plural} – filtrerat på ”${q}”` : `${n} ${plural}`;
    if (badgeText) badgeText.textContent = text;
  };
}

/* === ADVANCED MARKER === */
function makeAdvancedMarker(pos,title){
  const el=document.createElement("div");
  el.className="sdab-pin";
  el.style.setProperty("--sdab-green","#0A4003");
  const img=document.createElement("img");
  img.src=SDAB_LOGO_URL; img.alt="SDAB";
  img.onerror=()=>{ el.textContent="S"; el.style.font="600 14px/1 system-ui"; el.style.color="#0A4003"; };
  el.appendChild(img);
  return new google.maps.marker.AdvancedMarkerElement({ position:pos, title, content:el });
}

/* === INFO CARD === */
function buildInfoCard(p, onClose){
  const card=document.createElement("div");
  card.className="sdab-card";
  card.innerHTML=`
    <div class="sdab-card__header">
      <img class="sdab-card__logo" src="./SDAB_Logo_RGB_Horizontal.png" alt="Svensk Däckåtervinning">
      <button class="sdab-close" aria-label="Stäng">×</button>
    </div>
    <div class="sdab-card__panel">
      <h3 class="sdab-card__title">${escapeHtml(p?.name ?? "")}</h3>
      <p class="sdab-card__addr">${escapeHtml(p?.address ?? "")}</p>
    </div>`;
  card.querySelector(".sdab-close")?.addEventListener("click",(e)=>{e.preventDefault();e.stopPropagation();onClose();});
  return card;
}

/* === INIT MAP === */
async function initMap(){
  // säkerställ att du bara har EN #map i DOM
  const maps = document.querySelectorAll("#map");
  if (maps.length > 1) for (let i=1;i<maps.length;i++) maps[i].remove();

  const loadingEl = document.getElementById("loading");
  const setBadge  = makeSetBadge();

  const cityInput = document.getElementById("cityInput");
  const cityGo    = document.getElementById("cityGo");
  const cityClear = document.getElementById("cityClear");

  const map = new google.maps.Map(document.getElementById("map"), {
    center: DEFAULT_CENTER, zoom: DEFAULT_ZOOM, mapTypeControl: true, mapId: MAP_ID
  });

  try{
    const data = await fetchPickupPlaces();
    const pins = Array.isArray(data?.Pins) ? data.Pins : (Array.isArray(data) ? data : []);

    const markers=[];
    const bounds = new google.maps.LatLngBounds();
    const infoWindow = new google.maps.InfoWindow();

    for(const p of pins){
      const pos=parseLocationString(p.location);
      if(!pos) continue;
      const m=makeAdvancedMarker(pos, p.name ?? "");
      m.addListener("gmp-click",()=>{
        try{infoWindow.close();}catch{}
        infoWindow.setContent(buildInfoCard(p, ()=>infoWindow.close()));
        infoWindow.open({ map, anchor:m });
      });
      markers.push(m);
      bounds.extend(pos);
    }

    // DEFAULT clusterer (ingen custom renderer)
    let clusterer = new markerClusterer.MarkerClusterer({ map, markers });

    // Badge: totalt antal
    setBadge(markers.length, "");

    // kamera
    if(markers.length>1){
      map.fitBounds(bounds);
      google.maps.event.addListenerOnce(map,"idle",()=>{ if(map.getZoom()>12) map.setZoom(12); });
    } else if (markers.length===1){
      map.setCenter(markers[0].position); map.setZoom(14);
    }

    // ==== FILTER ====
    function applyFilter(queryRaw){
      const q = norm(String(queryRaw ?? ""));
      const tokens = q.split(/[,\s]+/).filter(Boolean);

      const filtered=[];
      const fbounds=new google.maps.LatLngBounds();

      markers.forEach((m,i)=>{
        const p = pins[i];
        const hay = norm(`${p?.address||""} ${p?.name||""}`);
        const match = tokens.length===0 || tokens.every(t=>hay.includes(t));
        m.map = match ? map : null;
        if(match){
          filtered.push(m);
          const pos=parseLocationString(p.location);
          if(pos) fbounds.extend(pos);
        }
      });

      // uppdatera clusterer enkelt
      if (typeof clusterer.clearMarkers === "function") {
        clusterer.clearMarkers();
        if (filtered.length) clusterer.addMarkers(filtered);
      } else {
        clusterer = new markerClusterer.MarkerClusterer({ map, markers: filtered });
      }

      // Badge
      setBadge(filtered.length, String(queryRaw ?? "").trim());

      // kamera
      if(filtered.length>1){
        map.fitBounds(fbounds);
        google.maps.event.addListenerOnce(map,"idle",()=>{ if(map.getZoom()>12) map.setZoom(12); });
      } else if(filtered.length===1){
        map.setCenter(filtered[0].position); map.setZoom(14);
      }
    }

    // UI events (debounce)
    let debounceId;
    function onInput(){ clearTimeout(debounceId); debounceId=setTimeout(()=>applyFilter(cityInput.value),180); }
    cityInput?.addEventListener("input", onInput);
    cityInput?.addEventListener("keydown", e=>{ if(e.key==="Enter") applyFilter(cityInput.value); });
    cityGo?.addEventListener("click", ()=>applyFilter(cityInput.value));
    cityClear?.addEventListener("click", ()=>{ cityInput.value=""; applyFilter(""); });

    // Exponera manuellt test
    window.__setBadge = setBadge;

  }catch(err){
    console.error(err);
    setBadge(0, "");
    alert("Kunde inte ladda kartan.");
  }finally{
    if(loadingEl) loadingEl.style.display="none";
  }
}

/* === BOOT === */
window.initMap = initMap;
loadMaps();
</script>
</body>
</html>
