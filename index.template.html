<!doctype html>
<html lang="sv">

<head>
	<link rel="icon" href="./sdab_small.png" />
<link rel="preload" as="image" href="./sdab_small.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SDAB – Levande karta</title>
  <style>
    /* English comments in CSS per your preference */
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }

    .loading {
      position: fixed; inset: 0; display: grid; place-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #fff; z-index: 10;
    }
    .badge {
      position: fixed; right: 10px; top: 115px; z-index: 5;
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #D9DFD9; border: 2px solid #084001;
      padding: 6px 8px; border-radius: 6px;
		color: #084001;
    }

    /* === Advanced marker "badge" with SDAB logo === */
    .sdab-pin {
      /* Size of the circular marker */
      width: 34px; height: 34px; border-radius: 50%;
      display: grid; place-items: center;
      background: #D9DFD9;                         /* inner bg */
      border: 1px solid var(--sdab-green, #2E7D32);/* green border */
      box-shadow: 0 2px 8px rgba(0,0,0,.28);       /* pop! */
      transform: translate3d(0,0,0);
    }
    .sdab-pin img {
      width: 18px; height: 18px; display: block; border-radius: 50%;
    }

    /* === Nicer InfoWindow content === */
    .infocard {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: 320px;
    }
    .infocard .title {
      font-size: 16px; font-weight: 700; margin: 0 0 4px 0;
    }
    .infocard .addr {
      color: #374151;
    }
	/* Brandad info card (outer frame + inner panel) */
/* English comments as requested */
.sdab-card {
  --sdab-bg: #D9E0D9;      /* light beige/green */
  --sdab-border: #0A4003;  /* dark green */
  --sdab-shadow: 0 10px 24px rgba(0,0,0,.18);

  background: var(--sdab-bg);
  border: 2px solid var(--sdab-border) !important;
  border-radius: 28px;
  box-shadow: var(--sdab-shadow);
  padding: 16px 18px 18px;
  max-width: min(480px, 86vw);
  font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: #0A4003;
}

/* header row with logo */
.sdab-card__header {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 12px;
}
.sdab-card__logo {
  height: 28px; width: auto; display: block;
}

/* inner white panel */
.sdab-card__panel {
  background: #ffffff;
  border-radius: 22px;
  padding: 14px 16px;
  border: 1px solid #E5E7EB; /* subtle */
}

/* title + address */
.sdab-card__title {
  font-size: 16px; font-weight: 500; margin: 0 0 6px 0; color: #0A4003;
}
.sdab-card__addr { margin: 0; color: #374151; }

/* Remove the default white bubble from Google InfoWindow */
.gm-style-iw, .gm-style-iw-c {
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}

/* Remove the tip arrow shadow */
.gm-style-iw-t::after, .gm-style-iw-t::before {
  background: transparent !important;
  box-shadow: none !important;
}

.sdab-card {
  border-radius: 16px;   /* was 28px */
  border: 5px solid #0A4003;
  padding: 14px 16px 16px;
}
.sdab-card__panel {
  border-radius: 12px;   /* was 22px */
}

.gm-ui-hover-effect { display: none !important; }

.sdab-close {
  margin-left: auto;
  background: transparent;
  border: none;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  color: #0A4003;
}
/* Ensure the content area allows clicks and isn't clipping */

.sdab-card, .sdab-close { pointer-events: auto; }

/* Se till att innehållet tar emot klick */
.gm-style-iw-d { overflow: visible !important; }
.gm-ui-hover-effect { display: none !important; } /* vi kör vår egen knapp */

/* Se till att ingen parent blockerar klick */
.gm-style-iw-d { overflow: visible !important; pointer-events: auto !important; }

	  /* City search UI */
.search {
  position: fixed; right: 10px; top: 60px; z-index: 6;
  display: flex; gap: 6px; align-items: center;
  background: rgba(255,255,255,.95);
  border: 1px solid #E5E7EB; border-radius: 10px;
  padding: 8px 10px; box-shadow: 0 4px 14px rgba(0,0,0,.06);
  font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}
.search input {
  width: 220px; border: 0; outline: none; background: transparent;
}
.search button {
  border: 0; background: #0A4003; color: #fff; padding: 6px 10px;
  border-radius: 8px; cursor: pointer;
}
.search button.secondary {
  background: #D9E0D9; color:#0A4003;
}

  </style>
</head>
<body>
  <div class="loading" id="loading">Laddar karta…</div>
	<div class="search">
  <input id="cityInput" type="search" placeholder="Sök ort eller postnummer" />
  <button id="cityGo">Sök</button>
  <button id="cityClear" class="secondary">Rensa</button>
</div>

  <div id="map"></div>
  <div class="badge" id="badge">0 platser</div>

  <!-- MarkerClusterer (works with Advanced Markers) -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<script>
"use strict";

/* ==== CONFIG ==== */
const API_URL       = "https://sdabfunctions.azurewebsites.net/api/pickup-places?";
const SDAB_LOGO_URL = "./sdab_small.png";
const DEFAULT_CENTER= { lat: 62.0, lng: 15.0 };
const DEFAULT_ZOOM  = 5;
const MAP_ID        = "DEMO_MAP_ID";
const GMAPS_SRC     = "https://maps.googleapis.com/maps/api/js?v=weekly&libraries=marker&loading=async&key=$GMAPS_KEY&callback=initMap";

/* ==== LOAD MAPS ==== */
function loadMaps(){
  const s=document.createElement("script");
  s.src=GMAPS_SRC; s.async=true; document.head.appendChild(s);
}

/* ==== HELPERS ==== */
async function fetchPickupPlaces(){
  const r = await fetch(API_URL);
  if(!r.ok) throw new Error("API error "+r.status);
  return r.json();
}
function parseLocationString(loc){
  if(!loc) return null;
  const [lat,lng] = String(loc).split(",").map(Number);
  return (Number.isNaN(lat)||Number.isNaN(lng)) ? null : {lat,lng};
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]));
}
function norm(s){
  return String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/å/gi,"a").replace(/ä/gi,"a").replace(/ö/gi,"o")
    .toLowerCase().trim();
}

/* ==== BADGE (enkel) ==== */
function setBadge(count){
  const el = document.getElementById("badge");
  if(!el) return;
  const n = Number.isFinite(+count) ? +count : 0;
  el.textContent = `${n.toLocaleString("sv-SE")} hämtställen`;
  el.setAttribute("aria-label", el.textContent);
}

/* ==== ADVANCED MARKER (växla mellan logga och "1") ==== */
function makeAdvancedMarker(pos,title){
  const wrap = document.createElement("div");
  wrap.className = "sdab-pin";
  wrap.style.setProperty("--sdab-green","#0A4003");
  wrap.style.position = "relative";

  const img = document.createElement("img");
  img.src = SDAB_LOGO_URL; 
  img.alt = "SDAB";
  img.style.display = "block";
  img.onerror = () => {
    wrap.textContent = "S";
    wrap.style.font = "600 14px/1 system-ui";
    wrap.style.color = "#0A4003";
  };
  wrap.appendChild(img);

  // Overlay med "1" (mittcentrerad)
  const label = document.createElement("div");
  label.className = "sdab-pin__label";
  label.textContent = "1";
  Object.assign(label.style, {
    position: "absolute",
    inset: "0",
    display: "none",                 // start: dold (vi bestämmer via zoom)
    placeItems: "center",
    font: "700 12px/1 system-ui",
    color: "#0A4003",
    pointerEvents: "none"
  });
  wrap.appendChild(label);

  const marker = new google.maps.marker.AdvancedMarkerElement({
    position: pos,
    title,
    content: wrap,
    collisionBehavior: google.maps.CollisionBehavior.REQUIRED_AND_HIDES_OPTIONAL
  });

  marker.__labelEl = label; // för toggling
  marker.__imgEl   = img;   // för toggling
  return marker;
}

/* ==== INFO CARD ==== */
function buildInfoCard(p,onClose){
  const card=document.createElement("div");
  card.className="sdab-card";
  card.innerHTML=`
    <div class="sdab-card__header">
      <img class="sdab-card__logo" src="./SDAB_Logo_RGB_Horizontal.png" alt="Svensk Däckåtervinning">
      <button class="sdab-close" aria-label="Stäng">×</button>
    </div>
    <div class="sdab-card__panel">
      <h3 class="sdab-card__title">${escapeHtml(p?.name ?? "")}</h3>
      <p class="sdab-card__addr">${escapeHtml(p?.address ?? "")}</p>
    </div>`;
  card.querySelector(".sdab-close")?.addEventListener("click",(e)=>{ e.preventDefault(); e.stopPropagation(); onClose(); });
  return card;
}

/* ==== SDAB KLUSTER-RENDER (GRÖNA CIRKLAR) ==== */
function clusterRenderer({ count, position }){
  const c = Number.isFinite(+count) && +count>0 ? +count : 1;
  let SIZE=44, INNER=30, FONT=14, STROKE=2;
  if(c>=25 && c<100){ SIZE=52; INNER=36; FONT=16; }
  else if(c>=100 && c<250){ SIZE=60; INNER=42; FONT=18; }
  else if(c>=250){ SIZE=72; INNER=50; FONT=20; }

  const NS="http://www.w3.org/2000/svg";
  const svg=document.createElementNS(NS,"svg");
  svg.setAttribute("viewBox",`0 0 ${SIZE} ${SIZE}`);
  svg.setAttribute("width",String(SIZE));
  svg.setAttribute("height",String(SIZE));

  const cx=SIZE/2, cy=SIZE/2;
  const BG="#D9E0D9", BORDER="#0A4003", NUM="#0A4003";

  const ring=document.createElementNS(NS,"circle");
  ring.setAttribute("cx",cx); ring.setAttribute("cy",cy);
  ring.setAttribute("r",(SIZE/2)-STROKE);
  ring.setAttribute("fill",BG);
  ring.setAttribute("stroke",BORDER);
  ring.setAttribute("stroke-width",String(STROKE));
  svg.appendChild(ring);

  const inner=document.createElementNS(NS,"circle");
  inner.setAttribute("cx",cx); inner.setAttribute("cy",cy);
  inner.setAttribute("r",INNER/2); inner.setAttribute("fill",BG);
  svg.appendChild(inner);

  const t=document.createElementNS(NS,"text");
  t.setAttribute("x",cx); t.setAttribute("y",cy);
  t.setAttribute("text-anchor","middle"); t.setAttribute("dominant-baseline","middle");
  t.setAttribute("font-size",String(FONT)); t.setAttribute("font-weight","800"); t.setAttribute("fill",NUM);
  t.textContent=String(c);
  svg.appendChild(t);

  return new google.maps.marker.AdvancedMarkerElement({ position, content: svg });
}

/* ==== SINGLE-PIN TOGGLE ==== */
/* Zoom ≤ 7: visa endast "1". Zoom > 7: visa endast logga. */
const LOGO_ONLY_MIN_ZOOM = 8; // dvs >7
function updateSinglePinLabels(map, markerList){
  const z = map.getZoom() ?? 0;
  const showLogo = z >= LOGO_ONLY_MIN_ZOOM; // true = logga, false = "1"
  for (const m of markerList) {
    if (!m) continue;
    if (m.__imgEl)   m.__imgEl.style.display   = showLogo ? "block" : "none";
    if (m.__labelEl) m.__labelEl.style.display = showLogo ? "none"  : "grid";
  }
}

/* ==== INIT MAP ==== */
async function initMap(){
  // Rensa ev. dubblett #map
  document.querySelectorAll("#map").forEach((el,i)=>{ if(i>0) el.remove(); });

  const loadingEl = document.getElementById("loading");
  const map = new google.maps.Map(document.getElementById("map"), {
    center: DEFAULT_CENTER, zoom: DEFAULT_ZOOM, mapTypeControl: true, mapId: MAP_ID
  });

  const cityInput = document.getElementById("cityInput");
  const cityGo    = document.getElementById("cityGo");
  const cityClear = document.getElementById("cityClear");

  let pins = [];
  let markers = [];
  let activeMarkers = [];   // markörer som clusterer hanterar just nu (filter = subset)
  let clusterer = null;
  const infoWindow = new google.maps.InfoWindow();

  // indexhjälp för att bara söka ORT/POSTNR
  function parseZipCity(address){
    const raw = String(address || "");
    const m = raw.match(/\b(\d{3}\s?\d{2})\b/); // 12345 eller 123 45
    const zip = m ? m[1].replace(/\s/g,"") : "";
    let city = "";
    const parts = raw.split(",").map(s=>s.trim()).filter(Boolean);
    if (parts.length >= 2) city = parts[parts.length - 1];
    else if (m) city = raw.slice(m.index + m[0].length).trim();
    return { zip, city };
  }

  // badge = antal synliga i viewport
  function updateBadgeByViewport() {
    if (!activeMarkers.length) { setBadge(0); return; }
    const bounds = map.getBounds();
    if (!bounds) { setBadge(activeMarkers.length); return; }
    let visible = 0;
    for (const m of activeMarkers) {
      const pos = m.position;
      if (pos && bounds.contains(pos)) visible++;
    }
    setBadge(visible);
  }

  try{
    const data = await fetchPickupPlaces();
    pins = Array.isArray(data?.Pins) ? data.Pins : (Array.isArray(data) ? data : []);

    // Bygg markörer
    const bounds = new google.maps.LatLngBounds();
    markers = [];
    for(const p of pins){
      const pos = parseLocationString(p.location);
      if(!pos) continue;
      const m = makeAdvancedMarker(pos, p.name ?? "");
      m.addListener("gmp-click",()=>{
        try{ infoWindow.close(); }catch{}
        infoWindow.setContent(buildInfoCard(p, ()=>infoWindow.close()));
        infoWindow.open({ map, anchor:m });
      });
      markers.push(m);
      bounds.extend(pos);
    }

    // Index för sök (enbart ort & postnummer)
    const idx = pins.map(p=>{
      const { zip, city } = parseZipCity(p.address);
      return { zipNorm: norm(zip), cityNorm: norm(city), loc: parseLocationString(p.location) };
    });

    // Klustrare (grön SDAB-stil)
    activeMarkers = markers.slice(); // initialt alla
    clusterer = new markerClusterer.MarkerClusterer({
      map, markers: activeMarkers, renderer: { render: clusterRenderer }
    });

    // Init UI efter första idle
    google.maps.event.addListenerOnce(map, "idle", () => {
      updateBadgeByViewport();
      updateSinglePinLabels(map, activeMarkers);
    });

    // Kamera INIT
    if(markers.length>1){
      map.fitBounds(bounds);
      google.maps.event.addListenerOnce(map,"idle",()=>{ if(map.getZoom()>12) map.setZoom(12); });
    } else if (markers.length===1){
      map.setCenter(markers[0].position); map.setZoom(14);
    }

    // Uppdatera vid vy/zoom
    map.addListener("idle", () => {
      updateBadgeByViewport();
      updateSinglePinLabels(map, activeMarkers.length ? activeMarkers : markers);
    });
    map.addListener("zoom_changed", () => {
      updateSinglePinLabels(map, activeMarkers.length ? activeMarkers : markers);
    });

    // ====== FILTER: endast ORT/POSTNR ======
    function matches(entry, tokens){
      if(!tokens.length) return true;
      for(const t of tokens){
        if(/^\d+$/.test(t)){            // siffror → postnr-början
          if(!entry.zipNorm.startsWith(t)) return false;
        } else {                        // bokstäver → ort
          if(!entry.cityNorm.includes(t)) return false;
        }
      }
      return true;
    }

    function applyFilter(raw){
      const display = String(raw ?? "");
      const tokens  = norm(display).split(/\s+/).filter(Boolean);

      try{ infoWindow.close(); }catch{}

      const next = [];
      const fit = new google.maps.LatLngBounds();

      for(let i=0;i<markers.length;i++){
        const keep = matches(idx[i], tokens);
        if(keep){
          next.push(markers[i]);
          if(idx[i].loc) fit.extend(idx[i].loc);
        }
      }

      // Uppdatera clusterer
      if (typeof clusterer.clearMarkers === "function") {
        clusterer.clearMarkers();
        if (next.length) clusterer.addMarkers(next);
      } else {
        clusterer = new markerClusterer.MarkerClusterer({ map, markers: next, renderer: { render: clusterRenderer } });
      }
      activeMarkers = next;

      // Uppdatera UI
      updateSinglePinLabels(map, activeMarkers);
      updateBadgeByViewport();

      // kamera
      if(next.length>1){
        map.fitBounds(fit);
        google.maps.event.addListenerOnce(map,"idle",()=>{ if(map.getZoom()>12) map.setZoom(12); });
      } else if (next.length===1){
        map.setCenter(next[0].position); map.setZoom(14);
      }
    }

    // UI (debounce)
    let debounceId;
    function onInput(){ clearTimeout(debounceId); debounceId=setTimeout(()=>applyFilter(cityInput.value),180); }
    cityInput?.addEventListener("input", onInput);
    cityInput?.addEventListener("keydown", e=>{ if(e.key==="Enter") applyFilter(cityInput.value); });
    cityGo?.addEventListener("click", ()=>applyFilter(cityInput.value));
    cityClear?.addEventListener("click", ()=>{ cityInput.value=""; applyFilter(""); });

    // test i konsol: window.__filter("Malmö") / __filter("12345")
    window.__filter = applyFilter;

  }catch(err){
    console.error(err);
    setBadge(0);
    alert("Kunde inte ladda kartan.");
  }finally{
    const l=document.getElementById("loading"); if(l) l.style.display="none";
  }
}

/* ==== BOOT ==== */
window.initMap = initMap;
loadMaps();
</script>
</body>
</html>
