<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SDAB – Levande karta</title>
  <style>
    /* English comments in CSS per your preference */
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }

    .loading {
      position: fixed; inset: 0; display: grid; place-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #fff; z-index: 10;
    }
    .badge {
      position: fixed; left: 8px; bottom: 8px; z-index: 5;
      font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: rgba(255,255,255,0.9); border: 1px solid #ddd;
      padding: 6px 8px; border-radius: 6px;
    }

    /* === Advanced marker "badge" with SDAB logo === */
    .sdab-pin {
      /* Size of the circular marker */
      width: 34px; height: 34px; border-radius: 50%;
      display: grid; place-items: center;
      background: #ffffff;                         /* inner bg */
      border: 3px solid var(--sdab-green, #2E7D32);/* green border */
      box-shadow: 0 2px 8px rgba(0,0,0,.28);       /* pop! */
      transform: translate3d(0,0,0);
    }
    .sdab-pin img {
      width: 18px; height: 18px; display: block; border-radius: 50%;
    }

    /* === Nicer InfoWindow content === */
    .infocard {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: 320px;
    }
    .infocard .title {
      font-size: 16px; font-weight: 700; margin: 0 0 4px 0;
    }
    .infocard .addr {
      color: #374151;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">Laddar karta…</div>
  <div id="map"></div>
  <div class="badge" id="badge">0 platser</div>

  <!-- MarkerClusterer (works with Advanced Markers) -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

  <script>
    // ===== CONFIG =====
    // Replace with your Azure Function endpoint
    const API_URL = "https://sdabgetpickupplaces.azurewebsites.net/api/pickup-places?";


    // SDAB logo used inside the circular marker
const SDAB_LOGO_URL = "sdab_small.png";

    // SDAB-ish palette (tweak freely)
    const SDAB_BACKGROUND  = "#D9E0D9";  // cluster outer ring
    const SDAB_GREEN_DARK = "#0A4003";
    const SDAB_GREEN_LIGHT = "#697760";  // cluster inner fill & pin border

    // Map defaults
    const DEFAULT_CENTER = { lat: 62.0, lng: 15.0 };
    const DEFAULT_ZOOM   = 5;

    // Vector map id (required for Advanced Markers). Replace with your own later.
    const MAP_ID = "DEMO_MAP_ID";

    // ===== LOAD GOOGLE MAPS (Advanced Markers) =====
    async function loadMaps() {
      const s = document.createElement('script');
      // v=weekly + libraries=marker for AdvancedMarkerElement
      s.src = "https://maps.googleapis.com/maps/api/js?v=weekly&libraries=marker&key=$GMAPS_KEY&callback=initMap";
      s.async = true;
      document.head.appendChild(s);
    }

    // ===== DATA FETCH =====
    async function fetchPickupPlaces() {
      const res = await fetch(API_URL, { method: "GET" });
      if (!res.ok) throw new Error("Kunde inte hämta pickup places");
      return res.json();
    }

    function parseLocationString(loc) {
      if (!loc) return null;
      const [lat, lng] = loc.split(",").map(Number);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
      return { lat, lng };
    }

    // ===== ADVANCED MARKER (circular badge with logo) =====
    function makeAdvancedMarker(pos, title) {
      const el = document.createElement("div");
      el.className = "sdab-pin";
      el.style.setProperty("--sdab-green", SDAB_GREEN_DARK);
      el.innerHTML = `<img src="${SDAB_LOGO_URL}" alt="SDAB">`;

      // AdvancedMarkerElement with custom HTML content
      return new google.maps.marker.AdvancedMarkerElement({
        position: pos,
        title,
        content: el
      });
    }

/* Cluster renderer: light background, thin dark border, dark number.
   Also scales size by count and is defensive about numeric values. */
function clusterRenderer({ count, position }) {
  const n = Number(count) || 0;

  // Size buckets
  let outer = 52, inner = 34, font = 16;
  if (n >= 50 && n < 200) { outer = 60; inner = 40; font = 18; }
  else if (n >= 200)      { outer = 70; inner = 46; font = 20; }

  const svgNS = "http://www.w3.org/2000/svg";
  const svg   = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${outer} ${outer}`);  // <= valid even when scaled
  svg.setAttribute("width", String(outer));
  svg.setAttribute("height", String(outer));

  const cx = outer / 2;
  const cy = outer / 2;
  const rOuter = (outer / 2) - 1;   // thin border
  const rInner = inner / 2;

  // Colors (inline hex for clarity)
  const BG_LIGHT    = "#D9E0D9";  // light background
  const BORDER_DARK = "#0A4003";  // dark ring
  const INNER_LIGHT = "#D9E0D9";  // same light shade (flat look)
  const NUM_DARK    = "#0A4003";  // dark number

  // Outer ring (light fill + thin dark stroke)
  const ring = document.createElementNS(svgNS, "circle");
  ring.setAttribute("cx", String(cx));
  ring.setAttribute("cy", String(cy));
  ring.setAttribute("r",  String(rOuter));
  ring.setAttribute("fill", BG_LIGHT);
  ring.setAttribute("stroke", BORDER_DARK);
  ring.setAttribute("stroke-width", "1.5");
  svg.appendChild(ring);

  // Inner disk (light fill for soft badge)
  const innerDisk = document.createElementNS(svgNS, "circle");
  innerDisk.setAttribute("cx", String(cx));
  innerDisk.setAttribute("cy", String(cy));
  innerDisk.setAttribute("r",  String(rInner));
  innerDisk.setAttribute("fill", INNER_LIGHT);
  svg.appendChild(innerDisk);

  // Count text (dark, centered; slight stroke for readability on any bg)
  const text = document.createElementNS(svgNS, "text");
  text.setAttribute("x", String(cx));
  text.setAttribute("y", String(cy));
  text.setAttribute("text-anchor", "middle");
  text.setAttribute("dominant-baseline", "middle");
  text.setAttribute("font-size", String(font));
  text.setAttribute("font-weight", "800");
  text.setAttribute("fill", NUM_DARK);
  text.setAttribute("paint-order", "stroke");
  text.setAttribute("stroke", "rgba(255,255,255,0.6)");
  text.setAttribute("stroke-width", "1");
  text.textContent = String(n);
  svg.appendChild(text);

  return new google.maps.marker.AdvancedMarkerElement({
    position,
    content: svg
  });
}

    // ===== INIT MAP =====
    async function initMap() {
      const badgeEl   = document.getElementById("badge");
      const loadingEl = document.getElementById("loading");

      const map = new google.maps.Map(document.getElementById("map"), {
        center: DEFAULT_CENTER,
        zoom: DEFAULT_ZOOM,
        mapTypeControl: true,
        mapId: MAP_ID
      });

      try {
        const data = await fetchPickupPlaces();
        const pins = Array.isArray(data?.Pins) ? data.Pins : [];
        badgeEl.textContent = `${pins.length} platser`;

        const markers = [];
        const bounds = new google.maps.LatLngBounds();
        const infoWindow = new google.maps.InfoWindow();

        for (const p of pins) {
          const pos = parseLocationString(p.location);
          if (!pos) continue;

          const marker = makeAdvancedMarker(pos, p.name ?? "");

          marker.addListener("gmp-click", () => {
            infoWindow.setContent(
              `<div class="infocard">
                <div class="title">${escapeHtml(p.name ?? "")}</div>
                <div class="addr">${escapeHtml(p.address ?? "")}</div>
              </div>`
            );
            infoWindow.setPosition(pos);
            infoWindow.open({ map });
          });

          markers.push(marker);
          bounds.extend(pos);
        }

        // Cluster using Advanced Markers with SDAB renderer
        new markerClusterer.MarkerClusterer({
          map,
          markers,
          renderer: { render: clusterRenderer }
        });

        if (markers.length > 1) {
          map.fitBounds(bounds);
          google.maps.event.addListenerOnce(map, "idle", () => {
            if (map.getZoom() > 12) map.setZoom(12);
          });
        }
      } catch (err) {
        console.error(err);
        badgeEl.textContent = "Fel vid laddning";
        alert("Kunde inte ladda kartan.");
      } finally {
        loadingEl.style.display = "none";
      }
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (s) => {
        return { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s];
      });
    }

    // Expose for Google Maps callback
    window.initMap = initMap;

    // Kick off
    loadMaps().catch((err) => {
      console.error('Failed to load Google Maps script:', err);
    });
  </script>
</body>
</html>
