<!doctype html>
<html lang="sv">

<head>
	<link rel="icon" href="./sdab_small.png" />
<link rel="preload" as="image" href="./sdab_small.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SDAB – Levande karta</title>
  <style>
    /* English comments in CSS per your preference */
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }

    .loading {
      position: fixed; inset: 0; display: grid; place-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #fff; z-index: 10;
    }
    .badge {
  position: fixed; left: 12px; bottom: 12px; z-index: 6;
  display: flex; align-items: center; gap: 10px;
  background: transparent; border: 0; padding: 0;
  font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  pointer-events: none;
}

.badge .ring {
  width: 48px; height: 48px; position: relative; border-radius: 50%;
  background: #D9E0D9;
  border: 2px solid #0A4003;
  box-shadow: 0 2px 6px rgba(0,0,0,.25);
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}

.badge .ring img {
  width: 18px; height: 18px;
  border-radius: 50%;
  margin-right: 2px;
}

.badge .num {
  color: #0A4003; font-weight: 800; font-size: 14px;
}

.badge .text {
  color: #0A4003; font-weight: 600;
  background: rgba(255,255,255,.92);
  border: 1px solid #E5E7EB;
  padding: 8px 10px; border-radius: 10px;
  pointer-events: auto;
}

.badge.filtered .text {
  background: #D9E0D9;
  border-color: #0A4003;
}

    /* === Advanced marker "badge" with SDAB logo === */
    .sdab-pin {
      /* Size of the circular marker */
      width: 34px; height: 34px; border-radius: 50%;
      display: grid; place-items: center;
      background: #D9DFD9;                         /* inner bg */
      border: 1px solid var(--sdab-green, #2E7D32);/* green border */
      box-shadow: 0 2px 8px rgba(0,0,0,.28);       /* pop! */
      transform: translate3d(0,0,0);
    }
    .sdab-pin img {
      width: 18px; height: 18px; display: block; border-radius: 50%;
    }

    /* === Nicer InfoWindow content === */
    .infocard {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: 320px;
    }
    .infocard .title {
      font-size: 16px; font-weight: 700; margin: 0 0 4px 0;
    }
    .infocard .addr {
      color: #374151;
    }
	/* Brandad info card (outer frame + inner panel) */
/* English comments as requested */
.sdab-card {
  --sdab-bg: #D9E0D9;      /* light beige/green */
  --sdab-border: #0A4003;  /* dark green */
  --sdab-shadow: 0 10px 24px rgba(0,0,0,.18);

  background: var(--sdab-bg);
  border: 2px solid var(--sdab-border) !important;
  border-radius: 28px;
  box-shadow: var(--sdab-shadow);
  padding: 16px 18px 18px;
  max-width: min(480px, 86vw);
  font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: #0A4003;
}

/* header row with logo */
.sdab-card__header {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 12px;
}
.sdab-card__logo {
  height: 28px; width: auto; display: block;
}

/* inner white panel */
.sdab-card__panel {
  background: #ffffff;
  border-radius: 22px;
  padding: 14px 16px;
  border: 1px solid #E5E7EB; /* subtle */
}

/* title + address */
.sdab-card__title {
  font-size: 16px; font-weight: 500; margin: 0 0 6px 0; color: #0A4003;
}
.sdab-card__addr { margin: 0; color: #374151; }

/* Remove the default white bubble from Google InfoWindow */
.gm-style-iw, .gm-style-iw-c {
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}

/* Remove the tip arrow shadow */
.gm-style-iw-t::after, .gm-style-iw-t::before {
  background: transparent !important;
  box-shadow: none !important;
}

.sdab-card {
  border-radius: 16px;   /* was 28px */
  border: 5px solid #0A4003;
  padding: 14px 16px 16px;
}
.sdab-card__panel {
  border-radius: 12px;   /* was 22px */
}

.gm-ui-hover-effect { display: none !important; }

.sdab-close {
  margin-left: auto;
  background: transparent;
  border: none;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  color: #0A4003;
}
/* Ensure the content area allows clicks and isn't clipping */

.sdab-card, .sdab-close { pointer-events: auto; }

/* Se till att innehållet tar emot klick */
.gm-style-iw-d { overflow: visible !important; }
.gm-ui-hover-effect { display: none !important; } /* vi kör vår egen knapp */

/* Se till att ingen parent blockerar klick */
.gm-style-iw-d { overflow: visible !important; pointer-events: auto !important; }

	  /* City search UI */
.search {
  position: fixed; right: 60px; top: 10px; z-index: 6;
  display: flex; gap: 6px; align-items: center;
  background: rgba(255,255,255,.95);
  border: 1px solid #E5E7EB; border-radius: 10px;
  padding: 8px 10px; box-shadow: 0 4px 14px rgba(0,0,0,.06);
  font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}
.search input {
  width: 220px; border: 0; outline: none; background: transparent;
}
.search button {
  border: 0; background: #0A4003; color: #fff; padding: 6px 10px;
  border-radius: 8px; cursor: pointer;
}
.search button.secondary {
  background: #D9E0D9; color:#0A4003;
}

  </style>
</head>
<body>
  <div class="loading" id="loading">Laddar karta…</div>
	<div class="search">
  <input id="cityInput" type="search" placeholder="Sök ort eller postnummer" />
  <button id="cityGo">Sök</button>
  <button id="cityClear" class="secondary">Rensa</button>
</div>

<div id="map"></div>
  <div id="map"></div>
  <div class="badge" id="badge">0 platser</div>

  <!-- MarkerClusterer (works with Advanced Markers) -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

<script>
// ===== CONFIG =====
const API_URL = "https://sdabgetpickupplaces.azurewebsites.net/api/pickup-places?";
const SDAB_LOGO_URL = "./sdab_small.png";
const DEFAULT_CENTER = { lat: 62.0, lng: 15.0 };
const DEFAULT_ZOOM   = 5;
const MAP_ID = "DEMO_MAP_ID"; // byt till din riktiga mapId

// ===== Load Google Maps (Advanced Markers) =====
function loadMaps() {
  const s = document.createElement('script');
  // v=weekly + libraries=marker krävs för AdvancedMarkerElement
  s.src = "https://maps.googleapis.com/maps/api/js?v=weekly&libraries=marker&loading=async&key=$GMAPS_KEY&callback=initMap";
  s.async = true;
  document.head.appendChild(s);
}

// ===== Utils =====
async function fetchPickupPlaces() {
  const res = await fetch(API_URL, { method: "GET" });
  if (!res.ok) throw new Error("Kunde inte hämta pickup places");
  return res.json();
}
function parseLocationString(loc) {
  if (!loc) return null;
  const [lat, lng] = loc.split(",").map(Number);
  if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
  return { lat, lng };
}
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, (s) =>
    ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s])
  );
}

// ===== Markers =====
function makeAdvancedMarker(pos, title) {
  const el = document.createElement("div");
  el.className = "sdab-pin";
  el.style.setProperty("--sdab-green", "#0A4003");

  const img = document.createElement("img");
  img.src = SDAB_LOGO_URL;
  img.alt = "SDAB";
  img.onerror = () => {
    el.textContent = "S";
    el.style.font = "600 14px/1 system-ui";
    el.style.color = "#0A4003";
  };
  el.appendChild(img);

  return new google.maps.marker.AdvancedMarkerElement({
    position: pos,
    title,
    content: el
  });
}

// ===== Info card =====
function buildInfoCard(p, onClose) {
  const card = document.createElement("div");
  card.className = "sdab-card";
  card.innerHTML = `
    <div class="sdab-card__header">
      <img class="sdab-card__logo" src="./SDAB_Logo_RGB_Horizontal.png" alt="Svensk Däckåtervinning">
      <button class="sdab-close" aria-label="Stäng">×</button>
    </div>
    <div class="sdab-card__panel">
      <h3 class="sdab-card__title">${escapeHtml(p.name ?? "")}</h3>
      <p class="sdab-card__addr">${escapeHtml(p.address ?? "")}</p>
    </div>
  `;
  card.querySelector(".sdab-close").addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    onClose();
    setTimeout(() => { try { onClose(); } catch {} }, 0);
  });
  return card;
}

// ===== SDAB cluster renderer (storlek efter antal) =====
function clusterRenderer({ count, position }) {
  const n = Number.parseInt(String(count ?? "").trim(), 10);
  const c = Number.isFinite(n) && n > 0 ? n : 1;

  // Bas + buckets
  let SIZE = 44, INNER = 30, FONT = 14, STROKE = 2;
  if (c >= 25 && c < 100)       { SIZE = 52; INNER = 36; FONT = 16; }
  else if (c >= 100 && c < 250) { SIZE = 60; INNER = 42; FONT = 18; }
  else if (c >= 250)            { SIZE = 72; INNER = 50; FONT = 20; }

  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", `0 0 ${SIZE} ${SIZE}`);
  svg.setAttribute("width", String(SIZE));
  svg.setAttribute("height", String(SIZE));

  const cx = SIZE / 2, cy = SIZE / 2;
  const BG_LIGHT = "#D9E0D9", BORDER_DARK = "#0A4003", NUM_DARK = "#0A4003";

  const ring = document.createElementNS(svgNS, "circle");
  ring.setAttribute("cx", String(cx));
  ring.setAttribute("cy", String(cy));
  ring.setAttribute("r", String((SIZE/2) - STROKE));
  ring.setAttribute("fill", BG_LIGHT);
  ring.setAttribute("stroke", BORDER_DARK);
  ring.setAttribute("stroke-width", String(STROKE));
  svg.appendChild(ring);

  const inner = document.createElementNS(svgNS, "circle");
  inner.setAttribute("cx", String(cx));
  inner.setAttribute("cy", String(cy));
  inner.setAttribute("r", String(INNER/2));
  inner.setAttribute("fill", BG_LIGHT);
  svg.appendChild(inner);

  const text = document.createElementNS(svgNS, "text");
  text.setAttribute("x", String(cx));
  text.setAttribute("y", String(cy));
  text.setAttribute("text-anchor", "middle");
  text.setAttribute("dominant-baseline", "middle");
  text.setAttribute("font-size", String(FONT));
  text.setAttribute("font-weight", "800");
  text.setAttribute("fill", NUM_DARK);
  text.textContent = String(c);
  svg.appendChild(text);

  return new google.maps.marker.AdvancedMarkerElement({ position, content: svg });
}
	function updateCounter(count, query){
  const badge = document.getElementById("badge");
  const safeQuery = query ? escapeHtml(query) : "";
  badge.innerHTML = `
    <div class="ring">
      <img src="./sdab_small.png" alt="SDAB">
      <div class="num">${count}</div>
    </div>
    <div class="text">
      ${count} platser${safeQuery ? ` – filtrerat på “${safeQuery}”` : ""}
    </div>
  `;
  badge.classList.toggle("filtered", !!safeQuery);
}

// ===== INIT MAP (smooth cluster zoom + sök på ort/ZIP) =====
async function initMap() {
  const badgeEl   = document.getElementById("badge");
  const loadingEl = document.getElementById("loading");

  // Search UI elements (ska finnas i din HTML)
  const cityInput = document.getElementById("cityInput");
  const cityGo    = document.getElementById("cityGo");
  const cityClear = document.getElementById("cityClear");

  const map = new google.maps.Map(document.getElementById("map"), {
    center: DEFAULT_CENTER,
    zoom: DEFAULT_ZOOM,
    mapTypeControl: true,
    mapId: MAP_ID
  });

  // Mjuk, avbrytbar zoom (låser center)
  let zoomToken = 0;
  function smoothZoom(targetZoom, center) {
    targetZoom = Math.max(1, Math.min(20, targetZoom));
    const token = ++zoomToken;
    const stepDelay = 120; // 100–140 känns bra

    const step = () => {
      if (token !== zoomToken) return;
      const z = map.getZoom();
      if (z >= targetZoom) return;
      if (center) map.setCenter(center);
      map.setZoom(Math.min(z + 1, targetZoom));
      setTimeout(step, stepDelay);
    };
    step();
  }

  try {
    const data = await fetchPickupPlaces();
    const pins = Array.isArray(data?.Pins) ? data.Pins : [];
    badgeEl.textContent = `${pins.length} platser`;

    const markers = [];
    const bounds = new google.maps.LatLngBounds();
    const infoWindow = new google.maps.InfoWindow();

    // Markers
    for (const p of pins) {
      const pos = parseLocationString(p.location);
      if (!pos) continue;
      const marker = makeAdvancedMarker(pos, p.name ?? "");

      marker.addListener("gmp-click", () => {
        try { infoWindow.close(); } catch {}
        const node = buildInfoCard(p, () => infoWindow.close());
        infoWindow.setContent(node);
        infoWindow.open({ map, anchor: marker });
      });

      markers.push(marker);
      bounds.extend(pos);
    }

    // Clusterer
    let clusterer = new markerClusterer.MarkerClusterer({
      map,
      markers,
      renderer: { render: clusterRenderer }
    });

    // Klick på kluster → pan + smooth zoom
    function handleClusterClick(ev) {
      try { ev?.stop?.(); } catch {}
      try { ev?.preventDefault?.(); } catch {}
      try { ev?.domEvent?.stopPropagation?.(); } catch {}
      try { ev?.domEvent?.preventDefault?.(); } catch {}

      const cluster = ev?.cluster ?? ev?.[1];
      const pos = cluster?.position;
      if (!pos) return;

      map.panTo(pos);
      google.maps.event.addListenerOnce(map, "idle", () => {
        const next = Math.min(map.getZoom() + 2, 18);
        smoothZoom(next, pos);
      });
    }
    (typeof clusterer.addListener === "function"
      ? clusterer.addListener("clusterclick", handleClusterClick)
      : google.maps.event.addListener(clusterer, "clusterclick", handleClusterClick)
    );

    // Första vy
    if (markers.length > 1) {
      map.fitBounds(bounds);
      google.maps.event.addListenerOnce(map, "idle", () => {
        if (map.getZoom() > 12) map.setZoom(12);
      });
    }

    // ====== Sök på ort + postnummer (samma fält) ======
    function norm(s) {
      return String(s || "")
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/å/gi, "a").replace(/ä/gi, "a").replace(/ö/gi, "o")
        .toLowerCase().trim();
    }
    function parseZipCity(address) {
      const raw = String(address || "");
      const m = raw.match(/\b(\d{3}\s?\d{2})\b/);       // 123 45 eller 12345
      const zip = m ? m[1].replace(/\s/g, "") : "";
      let city = "";
      const parts = raw.split(",").map(s => s.trim()).filter(Boolean);
      if (parts.length >= 2) city = parts[parts.length - 1];
      else if (m) city = raw.slice(m.index + m[0].length).trim();
      return { zip, city };
    }

    // Indexera pins för snabb filter
    const idx = pins.map(p => {
      const { zip, city } = parseZipCity(p.address);
      return {
        zipNorm: norm(zip),           // t.ex. "90330"
        cityNorm: norm(city),         // t.ex. "umea"
        loc: parseLocationString(p.location)
      };
    });

    function matches(idxEntry, tokens) {
      if (!tokens.length) return true;
      for (const t of tokens) {
        if (/^\d+$/.test(t)) { // bara siffror ⇒ jämför postnr-början
          if (!idxEntry.zipNorm.startsWith(t)) return false;
        } else {               // bokstäver ⇒ matcha ort
          if (!idxEntry.cityNorm.includes(t)) return false;
        }
      }
      return true;
    }

    function applySearchFilter(query) {
      const tokens = norm(query).split(/\s+/).filter(Boolean);

      try { infoWindow.close(); } catch {}

      const shown = [];
      const fit = new google.maps.LatLngBounds();

      for (let i = 0; i < markers.length; i++) {
        const keep = matches(idx[i], tokens);
        markers[i].map = keep ? map : null; // visa/dölj AdvancedMarker
        if (keep && idx[i].loc) {
          shown.push(markers[i]);
          fit.extend(idx[i].loc);
        }
      }

      // uppdatera clusterer
      if (typeof clusterer.clearMarkers === "function") {
        clusterer.clearMarkers();
        if (shown.length) clusterer.addMarkers(shown);
      } else {
        clusterer = new markerClusterer.MarkerClusterer({
          map, markers: shown, renderer: { render: clusterRenderer }
        });
        (typeof clusterer.addListener === "function"
          ? clusterer.addListener("clusterclick", handleClusterClick)
          : google.maps.event.addListener(clusterer, "clusterclick", handleClusterClick)
        );
      }

      const total = shown.length;
      badgeEl.textContent = tokens.length
        ? `${total} platser – filtrerat på “${query}”`
        : `${pins.length} platser`;

      if (shown.length > 1) {
        map.fitBounds(fit);
        google.maps.event.addListenerOnce(map, "idle", () => {
          if (map.getZoom() > 12) map.setZoom(12);
        });
      } else if (shown.length === 1) {
        map.setCenter(shown[0].position);
        map.setZoom(14);
      }
    }

    // Hooka UI (med debounce)
    if (cityInput && cityGo && cityClear) {
      let debounceId;
      function onInput() {
        clearTimeout(debounceId);
        debounceId = setTimeout(() => applySearchFilter(cityInput.value), 180);
      }
      cityInput.addEventListener("input", onInput);
      cityInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") applySearchFilter(cityInput.value);
      });
      cityGo.addEventListener("click", () => applySearchFilter(cityInput.value));
      cityClear.addEventListener("click", () => { cityInput.value = ""; applySearchFilter(""); });
    }
    // ====== /Sök ======

  } catch (err) {
    console.error(err);
    badgeEl.textContent = "Fel vid laddning";
    alert("Kunde inte ladda kartan.");
  } finally {
    loadingEl.style.display = "none";
  }
}

// Expose för Google Maps callback & starta
window.initMap = initMap;
loadMaps();
</script>
</body>
</html>
