<!doctype html>
<html lang="sv">

<head>
	<link rel="icon" href="./sdab_small.png" />
<link rel="preload" as="image" href="./sdab_small.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SDAB – Levande karta</title>
  <style>
    /* English comments in CSS per your preference */
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100vh; }

    .loading {
      position: fixed; inset: 0; display: grid; place-items: center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #fff; z-index: 10;
    }
    .badge {
      position: fixed; left: 8px; bottom: 8px; z-index: 5;
      font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: rgba(255,255,255,0.9); border: 1px solid #ddd;
      padding: 6px 8px; border-radius: 6px;
    }

    /* === Advanced marker "badge" with SDAB logo === */
    .sdab-pin {
      /* Size of the circular marker */
      width: 34px; height: 34px; border-radius: 50%;
      display: grid; place-items: center;
      background: #D9DFD9;                         /* inner bg */
      border: 3px solid var(--sdab-green, #2E7D32);/* green border */
      box-shadow: 0 2px 8px rgba(0,0,0,.28);       /* pop! */
      transform: translate3d(0,0,0);
    }
    .sdab-pin img {
      width: 18px; height: 18px; display: block; border-radius: 50%;
    }

    /* === Nicer InfoWindow content === */
    .infocard {
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: 320px;
    }
    .infocard .title {
      font-size: 16px; font-weight: 700; margin: 0 0 4px 0;
    }
    .infocard .addr {
      color: #374151;
    }
	/* Brandad info card (outer frame + inner panel) */
/* English comments as requested */
.sdab-card {
  --sdab-bg: #D9E0D9;      /* light beige/green */
  --sdab-border: #0A4003;  /* dark green */
  --sdab-shadow: 0 10px 24px rgba(0,0,0,.18);

  background: var(--sdab-bg);
  border: 6px solid var(--sdab-border);
  border-radius: 28px;
  box-shadow: var(--sdab-shadow);
  padding: 16px 18px 18px;
  max-width: min(480px, 86vw);
  font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: #0A4003;
}

/* header row with logo */
.sdab-card__header {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 12px;
}
.sdab-card__logo {
  height: 28px; width: auto; display: block;
}

/* inner white panel */
.sdab-card__panel {
  background: #ffffff;
  border-radius: 22px;
  padding: 14px 16px;
  border: 1px solid #E5E7EB; /* subtle */
}

/* title + address */
.sdab-card__title {
  font-size: 18px; font-weight: 800; margin: 0 0 6px 0; color: #0A4003;
}
.sdab-card__addr { margin: 0; color: #374151; }

/* Remove the default white bubble from Google InfoWindow */
.gm-style-iw, .gm-style-iw-c {
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}

/* Remove the tip arrow shadow */
.gm-style-iw-t::after, .gm-style-iw-t::before {
  background: transparent !important;
  box-shadow: none !important;
}

.sdab-card {
  border-radius: 16px;   /* was 28px */
  border: 5px solid #0A4003;
  padding: 14px 16px 16px;
}
.sdab-card__panel {
  border-radius: 12px;   /* was 22px */
}

.gm-ui-hover-effect { display: none !important; }

.sdab-close {
  margin-left: auto;
  background: transparent;
  border: none;
  font-size: 20px;
  font-weight: bold;
  cursor: pointer;
  color: #0A4003;
}
/* Ensure the content area allows clicks and isn't clipping */

.sdab-card, .sdab-close { pointer-events: auto; }

/* Se till att innehållet tar emot klick */
.gm-style-iw-d { overflow: visible !important; }
.gm-ui-hover-effect { display: none !important; } /* vi kör vår egen knapp */

/* Se till att ingen parent blockerar klick */
.gm-style-iw-d { overflow: visible !important; pointer-events: auto !important; }

  </style>
</head>
<body>
  <div class="loading" id="loading">Laddar karta…</div>
  <div id="map"></div>
  <div class="badge" id="badge">0 platser</div>

  <!-- MarkerClusterer (works with Advanced Markers) -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

  <script>
  // ===== CONFIG =====
  const API_URL = "https://sdabgetpickupplaces.azurewebsites.net/api/pickup-places?";
  const SDAB_LOGO_URL = "./sdab_small.png";

  const DEFAULT_CENTER = { lat: 62.0, lng: 15.0 };
  const DEFAULT_ZOOM   = 5;
  const MAP_ID = "DEMO_MAP_ID";

  // ===== LOAD GOOGLE MAPS (Advanced Markers) =====
  async function loadMaps() {
    const s = document.createElement('script');
    s.src = "https://maps.googleapis.com/maps/api/js?v=weekly&libraries=marker&loading=async&key=$GMAPS_KEY&callback=initMap";
    s.async = true;
    document.head.appendChild(s);
  }

  // ===== UTIL =====
  async function fetchPickupPlaces() {
    const res = await fetch(API_URL, { method: "GET" });
    if (!res.ok) throw new Error("Kunde inte hämta pickup places");
    return res.json();
  }
  function parseLocationString(loc) {
    if (!loc) return null;
    const [lat, lng] = loc.split(",").map(Number);
    if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
    return { lat, lng };
  }
  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (s) =>
      ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[s])
    );
  }

  // ===== ADVANCED MARKER (circular badge with logo) =====
  function makeAdvancedMarker(pos, title) {
    const el = document.createElement("div");
    el.className = "sdab-pin";
    el.style.setProperty("--sdab-green", "#0A4003"); // dark border

    const img = document.createElement("img");
    img.src = SDAB_LOGO_URL;
    img.alt = "SDAB";
    img.referrerPolicy = "no-referrer";
    img.onerror = () => {
      el.textContent = "S";
      el.style.font = "600 14px/1 system-ui";
      el.style.color = "#0A4003";
    };
    el.appendChild(img);

    return new google.maps.marker.AdvancedMarkerElement({
      position: pos,
      title,
      content: el
    });
  }

  // ===== INFO CARD BUILDER (returns a DOM node) =====
  function buildInfoCard(p, onClose) {
    const card = document.createElement("div");
    card.className = "sdab-card";
    card.innerHTML = `
      <div class="sdab-card__header">
        <img class="sdab-card__logo" src="./SDAB_Logo_RGB_Horizontal.png" alt="Svensk Däckåtervinning">
        <button class="sdab-close" aria-label="Stäng">×</button>
      </div>
      <div class="sdab-card__panel">
        <h3 class="sdab-card__title">${escapeHtml(p.name ?? "")}</h3>
        <p class="sdab-card__addr">${escapeHtml(p.address ?? "")}</p>
      </div>
    `;
    const closeBtn = card.querySelector(".sdab-close");
    closeBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (typeof e.stopImmediatePropagation === "function") e.stopImmediatePropagation();
      onClose();
      setTimeout(() => { try { onClose(); } catch {} }, 0);
    });
    return card;
  }

  // ===== CLUSTER RENDERER (SDAB: light bg, dark border & number) =====
  function clusterRenderer({ count, position }) {
    const n = Number.parseInt(String(count ?? "").trim(), 10);
    const c = Number.isFinite(n) && n > 0 ? n : 1;

    let outer = 52, inner = 34, font = 16;
    if (c >= 50 && c < 200) { outer = 60; inner = 40; font = 18; }
    else if (c >= 200)      { outer = 70; inner = 46; font = 20; }

    outer = Math.round(outer); inner = Math.round(inner);

    const svgNS = "http://www.w3.org/2000/svg";
    const svg   = document.createElementNS(svgNS, "svg");
    svg.setAttribute("viewBox", `0 0 ${outer} ${outer}`);
    svg.setAttribute("width", String(outer));
    svg.setAttribute("height", String(outer));

    const cx = outer / 2, cy = outer / 2;
    const rOuter = Math.max(1, (outer / 2) - 1);
    const rInner = Math.max(1, inner / 2);

    const BG_LIGHT = "#D9E0D9", BORDER_DARK = "#0A4003", NUM_DARK = "#0A4003";

    const ring = document.createElementNS(svgNS, "circle");
    ring.setAttribute("cx", cx); ring.setAttribute("cy", cy);
    ring.setAttribute("r",  rOuter);
    ring.setAttribute("fill", BG_LIGHT);
    ring.setAttribute("stroke", BORDER_DARK);
    ring.setAttribute("stroke-width", "1.5");
    svg.appendChild(ring);

    const innerDisk = document.createElementNS(svgNS, "circle");
    innerDisk.setAttribute("cx", cx); innerDisk.setAttribute("cy", cy);
    innerDisk.setAttribute("r",  rInner);
    innerDisk.setAttribute("fill", BG_LIGHT);
    svg.appendChild(innerDisk);

    const text = document.createElementNS(svgNS, "text");
    text.setAttribute("x", cx); text.setAttribute("y", cy);
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("dominant-baseline", "middle");
    text.setAttribute("font-size", String(font));
    text.setAttribute("font-weight", "800");
    text.setAttribute("fill", NUM_DARK);
    text.setAttribute("paint-order", "stroke");
    text.setAttribute("stroke", "rgba(255,255,255,0.6)");
    text.setAttribute("stroke-width", "1");
    text.textContent = String(c);
    svg.appendChild(text);

    return new google.maps.marker.AdvancedMarkerElement({ position, content: svg });
  }

  // ===== Smooth zoom helper =====
  let __isZoomAnimating = false;
  function smoothZoom(map, targetZoom) {
    targetZoom = Math.max(1, Math.min(20, targetZoom));
    if (__isZoomAnimating) return;
    __isZoomAnimating = true;

    const step = () => {
      const z = map.getZoom();
      if (z >= targetZoom) { __isZoomAnimating = false; return; }
      map.setZoom(z + 1);
      google.maps.event.addListenerOnce(map, "idle", step);
    };
    step();
  }

  // ===== INIT MAP =====
  async function initMap() {
    const badgeEl   = document.getElementById("badge");
    const loadingEl = document.getElementById("loading");

    const map = new google.maps.Map(document.getElementById("map"), {
      center: DEFAULT_CENTER,
      zoom: DEFAULT_ZOOM,
      mapTypeControl: true,
      mapId: MAP_ID
    });

    try {
      const data = await fetchPickupPlaces();
      const pins = Array.isArray(data?.Pins) ? data.Pins : [];
      badgeEl.textContent = `${pins.length} platser`;

      const markers = [];
      const bounds = new google.maps.LatLngBounds();
      const infoWindow = new google.maps.InfoWindow();

      for (const p of pins) {
        const pos = parseLocationString(p.location);
        if (!pos) continue;

        const marker = makeAdvancedMarker(pos, p.name ?? "");

        marker.addListener("gmp-click", () => {
          try { infoWindow.close(); } catch {}
          const node = buildInfoCard(p, () => infoWindow.close());
          infoWindow.setContent(node);

          if (marker instanceof google.maps.marker.AdvancedMarkerElement) {
            infoWindow.open({ map, anchor: marker });
          } else {
            infoWindow.setPosition(pos);
            infoWindow.open({ map });
          }
        });

        markers.push(marker);
        bounds.extend(pos);
      }

      // ===== MarkerClusterer with smooth zoom on every click =====
      const clusterer = new markerClusterer.MarkerClusterer({
        map,
        markers,
        renderer: { render: clusterRenderer },
        onClusterClick: (event) => {
          // stoppa default (som ibland "hoppar")
          event.preventMapDefault();

          const cluster = event.cluster;
          const pos = cluster.position;

          // pan mjukt till klustrets center
          map.panTo(pos);

          // zooma in i fasta steg (2 nivåer) – justera om du vill
          const nextZoom = Math.min(map.getZoom() + 2, 18);
          smoothZoom(map, nextZoom);
        }
      });

      if (markers.length > 1) {
        map.fitBounds(bounds);
        google.maps.event.addListenerOnce(map, "idle", () => {
          if (map.getZoom() > 12) map.setZoom(12);
        });
      }
    } catch (err) {
      console.error(err);
      badgeEl.textContent = "Fel vid laddning";
      alert("Kunde inte ladda kartan.");
    } finally {
      loadingEl.style.display = "none";
    }
  }

  // Expose for Google Maps callback & kick off
  window.initMap = initMap;
  loadMaps().catch((err) => console.error('Failed to load Google Maps script:', err));
</script>
</body>
</html>
